{{ if .Values.enabled }}
{{ if .Values.custom_tags }}
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: "tracing-custom-tags"
  namespace: "istio-system"
spec:
  configPatches:
    - applyTo: NETWORK_FILTER  # http connection manager is a filter in Envoy
      match:
        # context omitted so that this applies to both sidecars and gateways
        listener:
          filterChain:
            filter:
              name: "envoy.http_connection_manager"
      patch:
        operation: MERGE
        value:
          typed_config:
            "@type": "type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager"
            tracing:
              custom_tags:
                {{- range .Values.custom_tags }}
                - tag: {{ quote .tag }}
                  {{- if .header}}
                  request_header:
                    name: {{ quote .header.name }}
                    {{- if .header.defaultValue }}
                    default_value: {{ quote .header.defaultValue }}
                    {{- end }}
                  {{- end }}
                  {{- if .literal }}
                  literal:
                    value: {{ quote .literal.value }}
                  {{- end }}
                  {{- if .environment}}
                  environment:
                    name: {{ quote .environment.name }}
                    {{- if .environment.defaultValue }}
                    default_value: {{ quote .environment.defaultValue }}
                    {{- end }}
                  {{- end }}
                {{- end }}
{{ end }}
{{ end }}
